<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Chat with <span id="chatWith"></span></h1>
        <div id="messages" class="messages"></div>
        <input type="text" id="messageInput" placeholder="Type your message here..." />
        <button onclick="sendMessage()">Send</button>
        <button onclick="goToMyChats()">My Chats</button>
        <button onclick="goToHomepage()">Back to Homepage</button>
    </div>

    <script>
        // Check if user is logged in
        if (!localStorage.getItem('secretKey')) {
            alert('You must log in first!');
            window.location.href = 'index.html'; // Redirect to login page
        }

        const chatWith = new URLSearchParams(window.location.search).get('user');
        document.getElementById('chatWith').textContent = chatWith;

        async function fetchMessages() {
            const response = await fetch(`https://api.jsonbin.io/v3/b/6715f722ad19ca34f8bbffde/latest`, {
                headers: {
                    'X-Master-Key': '$2a$10$kfsjxxgU.CH/RGF6GziguOZZFzjhlvxiaYAm2bC6l48gnj7WYrbUi'
                }
            });

            const data = await response.json();
            const chats = data.record.chats || [];

            // Filter messages for the current chat
            const messages = chats.find(chat => chat.with === chatWith)?.messages || [];
            displayMessages(messages);
        }

        function displayMessages(messages) {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = ''; // Clear previous messages

            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = message.sender === localStorage.getItem('username') ? 'my-message' : 'other-message';
                messageDiv.textContent = `${message.sender}: ${message.text}`;
                messagesContainer.appendChild(messageDiv);
            });

            // Scroll to the bottom of the chat
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const messageText = document.getElementById('messageInput').value;
            if (!messageText) {
                alert('Please enter a message.');
                return;
            }

            // Fetch existing chats to update
            const response = await fetch(`https://api.jsonbin.io/v3/b/6715f722ad19ca34f8bbffde/latest`, {
                headers: {
                    'X-Master-Key': '$2a$10$kfsjxxgU.CH/RGF6GziguOZZFzjhlvxiaYAm2bC6l48gnj7WYrbUi'
                }
            });

            const data = await response.json();
            const chats = data.record.chats || [];
            const chat = chats.find(chat => chat.with === chatWith);

            if (chat) {
                chat.messages.push({ sender: localStorage.getItem('username'), text: messageText });
            } else {
                chats.push({ with: chatWith, messages: [{ sender: localStorage.getItem('username'), text: messageText }] });
            }

            // Update the JSONBin with the modified chats
            await fetch(`https://api.jsonbin.io/v3/b/6715f722ad19ca34f8bbffde`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': '$2a$10$kfsjxxgU.CH/RGF6GziguOZZFzjhlvxiaYAm2bC6l48gnj7WYrbUi'
                },
                body: JSON.stringify({ chats })
            });

            document.getElementById('messageInput').value = ''; // Clear the input
            fetchMessages(); // Refresh messages
        }

        function goToMyChats() {
            window.location.href = 'mychats.html'; // Redirect to My Chats page
        }

        function goToHomepage() {
            window.location.href = 'homepage.html'; // Redirect to homepage
        }

        // Fetch messages on page load
        fetchMessages();
    </script>
</body>
</html>