<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Application</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px;
            margin: 10px 0;
            width: 100%;
            background: #5cb85c;
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 16px;
        }
        .messages {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 5px;
        }
        .my-message {
            background: #d1e7dd;
            text-align: right;
        }
        .other-message {
            background: #f8d7da;
            text-align: left;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container" id="loginContainer">
        <h1>Log in with Secret Key</h1>
        <input type="text" id="secretKeyInput" placeholder="Enter your secret key..." />
        <button onclick="login()">Login</button>
        <p>Don't have a secret key? <a href="#" onclick="showRegister()">Register now</a></p>
    </div>

    <div class="container hidden" id="registerContainer">
        <h1>Register</h1>
        <input type="text" id="registerKey" placeholder="Secret Key" />
        <input type="text" id="registerUsername" placeholder="Username" />
        <input type="text" id="registerName" placeholder="Name" />
        <button onclick="register()">Register</button>
        <button onclick="showLogin()">Back to Login</button>
    </div>

    <div class="container hidden" id="homepageContainer">
        <h1>Welcome to Chat</h1>
        <button onclick="goToProfile()">Profile</button>
        <button onclick="goToMyChats()">My Chats</button>
        <button onclick="goToSearch()">Search Users</button>
        <button onclick="logout()">Logout</button>
    </div>

    <div class="container hidden" id="profileContainer">
        <h1>Profile</h1>
        <input type="text" id="profileUsername" placeholder="Username" />
        <input type="text" id="profileName" placeholder="Name" />
        <button onclick="saveProfile()">Save</button>
        <button onclick="goToHomepage()">Back to Homepage</button>
    </div>

    <div class="container hidden" id="myChatsContainer">
        <h1>My Chats</h1>
        <div id="myChatsList" class="messages"></div>
        <button onclick="goToHomepage()">Back to Homepage</button>
    </div>

    <div class="container hidden" id="searchContainer">
        <h1>Search Users</h1>
        <input type="text" id="searchUsername" placeholder="Enter username to search..." />
        <button onclick="searchUser()">Search</button>
        <div id="userList" class="messages"></div>
        <button onclick="goToHomepage()">Back to Homepage</button>
    </div>

    <div class="container hidden" id="chatContainer">
        <h1 id="chatWith">Chat with</h1>
        <div id="messages" class="messages"></div>
        <input type="text" id="messageInput" placeholder="Type your message..." />
        <button onclick="sendMessage()">Send</button>
        <button onclick="goToMyChats()">Back to My Chats</button>
    </div>

    <script>
        const jsonBinId = '6713e37dacd3cb34a899bbcb'; // Your JSONBin ID
        const xMasterKey = '$2a$10$SjhSiTDW101gGwgR2EMuSeimya/ER6HzCFxrwOkhtxONDwVyeCpPO'; // Your x-master key

        let users = [];
        let currentUser;
        let chats = {};

        async function fetchData() {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${jsonBinId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': xMasterKey,
                }
            });
            const data = await response.json();
            users = data.record.users || [];
            chats = data.record.chats || {};
        }

        async function saveData() {
            await fetch(`https://api.jsonbin.io/v3/b/${jsonBinId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': xMasterKey,
                },
                body: JSON.stringify({ users, chats })
            });
        }

        function showRegister() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('registerContainer').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('registerContainer').classList.add('hidden');
            document.getElementById('loginContainer').classList.remove('hidden');
        }

        function goToHomepage() {
            document.getElementById('profileContainer').classList.add('hidden');
            document.getElementById('myChatsContainer').classList.add('hidden');
            document.getElementById('searchContainer').classList.add('hidden');
            document.getElementById('chatContainer').classList.add('hidden');
            document.getElementById('homepageContainer').classList.remove('hidden');
        }

        function goToProfile() {
            document.getElementById('homepageContainer').classList.add('hidden');
            document.getElementById('profileContainer').classList.remove('hidden');
            document.getElementById('profileUsername').value = currentUser.username;
            document.getElementById('profileName').value = currentUser.name;
        }

        function goToMyChats() {
            document.getElementById('homepageContainer').classList.add('hidden');
            document.getElementById('myChatsContainer').classList.remove('hidden');
            displayMyChats();
        }

        function goToSearch() {
            document.getElementById('homepageContainer').classList.add('hidden');
            document.getElementById('searchContainer').classList.remove('hidden');
            fetchUsers();
        }

        function displayMyChats() {
            const chatList = document.getElementById('myChatsList');
            chatList.innerHTML = '';
            Object.keys(chats).forEach(username => {
                if (chats[username].length > 0) {
                    chatList.innerHTML += `<div onclick="openChat('${username}')">${username}</div>`;
                }
            });
        }

        function fetchUsers() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            users.forEach(user => {
                userList.innerHTML += `<div onclick="openChat('${user.username}')">${user.username}</div>`;
            });
        }

        function openChat(username) {
            document.getElementById('searchContainer').classList.add('hidden');
            document.getElementById('chatContainer').classList.remove('hidden');
            document.getElementById('chatWith').innerText = `Chat with ${username}`;
            displayMessages(username);
        }

        function displayMessages(username) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            if (chats[username]) {
                chats[username].forEach(msg => {
                    messagesDiv.innerHTML += `<div class="message other-message">${msg}</div>`;
                });
            }
        }

        async function login() {
            const secretKey = document.getElementById('secretKeyInput').value;
            const user = users.find(u => u.secretKey === secretKey);
            if (user) {
                currentUser = user;
                goToHomepage();
            } else {
                alert('Invalid secret key. Please try again.');
            }
        }

        async function register() {
            const secretKey = document.getElementById('registerKey').value;
            const username = document.getElementById('registerUsername').value;
            const name = document.getElementById('registerName').value;

            if (users.some(user => user.username === username)) {
                alert('Username already exists. Please choose a different username.');
                return;
            }

            const newUser = { secretKey, username, name };
            users.push(newUser);
            await saveData();
            alert('Registration successful! You can now log in.');
            showLogin();
        }

        function saveProfile() {
            currentUser.username = document.getElementById('profileUsername').value;
            currentUser.name = document.getElementById('profileName').value;
            saveData();
            goToHomepage();
        }

        async function searchUser() {
            const username = document.getElementById('searchUsername').value;
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            const user = users.find(u => u.username === username);
            if (user) {
                userList.innerHTML = `<div onclick="openChat('${user.username}')">${user.username}</div>`;
            } else {
                userList.innerHTML = 'User not found.';
            }
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            if (!message) return;

            if (!chats[currentUser.username]) {
                chats[currentUser.username] = [];
            }
            chats[currentUser.username].push(message);
            saveData();

            // Clear the input
            messageInput.value = '';
            displayMessages(currentUser.username);
        }

        function logout() {
            currentUser = null;
            showLogin();
        }

        // Initial fetch of user data
        fetchData().then(() => {
            // Show login screen after fetching data
            showLogin();
        });
    </script>
</body>
</html>