<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Profile</h1>
        <input type="text" id="displayName" placeholder="Enter your display name" />
        <input type="text" id="username" placeholder="Enter your username" />
        <button onclick="updateProfile()">Save</button>
        <button onclick="goToHomepage()">Back to Homepage</button>
    </div>

    <script>
        // Check if user is logged in
        if (!localStorage.getItem('secretKey')) {
            alert('You must log in first!');
            window.location.href = 'index.html'; // Redirect to login page
        }

        // Load the user's current profile
        async function loadProfile() {
            const username = localStorage.getItem('username');

            // Fetch users from JSONBin
            const response = await fetch(`https://api.jsonbin.io/v3/b/6715f722ad19ca34f8bbffde/latest`, {
                headers: {
                    'X-Master-Key': '$2a$10$kfsjxxgU.CH/RGF6GziguOZZFzjhlvxiaYAm2bC6l48gnj7WYrbUi'
                }
            });

            const data = await response.json();
            const users = data.record.users || [];

            // Find the logged-in user
            const user = users.find(user => user.username === username);
            if (user) {
                document.getElementById('username').value = user.username;
                document.getElementById('displayName').value = user.displayName || '';
            }
        }

        async function updateProfile() {
            const newUsername = document.getElementById('username').value;
            const displayName = document.getElementById('displayName').value;

            if (!newUsername || !displayName) {
                alert('Please enter both username and display name.');
                return;
            }

            // Fetch users from JSONBin to check for existing usernames
            const response = await fetch(`https://api.jsonbin.io/v3/b/6715f722ad19ca34f8bbffde/latest`, {
                headers: {
                    'X-Master-Key': '$2a$10$kfsjxxgU.CH/RGF6GziguOZZFzjhlvxiaYAm2bC6l48gnj7WYrbUi'
                }
            });

            const data = await response.json();
            const users = data.record.users || [];

            // Check if the new username is already taken
            if (users.find(user => user.username === newUsername && user.username !== localStorage.getItem('username'))) {
                alert('Username already exists. Please choose another one.');
                return;
            }

            // Update the user's profile
            const currentUsername = localStorage.getItem('username');
            const updatedUsers = users.map(user => {
                if (user.username === currentUsername) {
                    return { ...user, username: newUsername, displayName };
                }
                return user;
            });

            // Update the JSONBin with the modified users list
            await fetch(`https://api.jsonbin.io/v3/b/6715f722ad19ca34f8bbffde`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': '$2a$10$kfsjxxgU.CH/RGF6GziguOZZFzjhlvxiaYAm2bC6l48gnj7WYrbUi'
                },
                body: JSON.stringify({ users: updatedUsers })
            });

            // Update localStorage
            localStorage.setItem('username', newUsername);
            alert('Profile updated successfully!');
            goToHomepage(); // Redirect to homepage
        }

        function goToHomepage() {
            window.location.href = 'homepage.html'; // Redirect to homepage
        }

        // Load the user's profile on page load
        loadProfile();
    </script>
</body>
</html>